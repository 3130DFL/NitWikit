---
title: 性能优化
sidebar_position: 1
---

# 性能优化

性能优化主要是针对低 TPS 和高 MPST 导致的服务器顿卡或长期不流畅。

## 区块

### 降低服务器模拟距离

:::tip

在此之前，你必须了解的是模拟距离（Simulate distance）和视野距离（View distance）区别（下文用 SDT和 VDT 分别指代）。

模拟距离指的是玩家在这个范围内的游戏行为正常进行，如动物、怪物等 AI 的寻路，生物生成，草地扩散，水流流动等。

视野距离指的是服务器将发送给玩家的区块的数据包的距离，在这个范围内，游戏行为不一定会继续发生（这取决于 SDT）

当玩家移动导致一个区域不在玩家的 SDT 中而又在 VDT 中，那么服务器只会读取这个区域的方块信息并发送给玩家。

而不会对这个区域进行加载。这是各种游戏常见的处理方式，弱化远处的计算能够使得服务器更加流畅。

:::

您可以在末地设置更高的 `view-distance` ，这可以让鞘翅飞的更舒服而不会占用很多资源。

另外，应该鼓励您的玩家安装 Bobby 或 Farsight 等 mod，可以在本地缓存区块，这不会对服务器性能造成任何影响！

#### 手动调整

在 `spigot.yml` 中可以设置服务器的模拟距离：

```yaml
simulate-distance: 8
#模拟距离为 8 chunks
```

如果你使用的默认 10 chunks 的模拟距离，这会非常影响性能，可以酌情减少，

`推荐值：3 - 8`

#### 自动调整

安装 [View Distance Tweaks](https://www.spigotmc.org/resources/view-distance-tweaks.75164/) 实现自动调整视野距离使得玩家增多时自动减少视野，玩家减少时自动增加视野。

### 降低区块生成速度

服务器生成区块非常消耗资源，希望你服务器进行了预生成，如果没有进行的话请阅读 [优化概论](overview.md)

在 `/config/paper-global.yml` 中有关于区块生成的一些参数

```yaml
chunk-loading-basic:
  #注：以下的单位均为 chunks / seconds
  player-max-chunk-generate-rate: -1.0
  #为每个玩家生成分块的最大速率，设置为-1 则禁用。
  player-max-chunk-load-rate: 100
  #任何单个播放器加载块的最大速率，设置为-1 则禁用。
  player-max-chunk-send-rate: 75
  #服务器发送给单个玩家的最大速率。设置为-1 则禁用。
```

其中 `player-max-chunk-generate-rate` 对应服务器每秒钟最多为玩家生成多少区块，设置得越低区块生成越慢。

此时大量跑图的玩家可能会觉得服务器有一些滞后，但是能够保证大多数玩家的游戏体验，这是值得的。

`推荐值：20 - 40`

### 调整区块卸载速度

区块的反复大量加载和卸载区块是很消耗性能的，而长期加载无效的区块也是浪费性能。

在 `paper-world-defaults.yml` 中可以调整玩家离开后多久开始卸载区块。

```yaml
chunks:
  delay-chunk-unloads-by: 10s
```

这有助于避免玩家来回移动时，服务器不断加载和卸载相同的区块。过高的值可能会导致一次加载太多区块。

在玩家频繁传送或加载的区域，可以考虑让该区域永久加载。这可以减轻服务器不小的负担。

| 推荐值 | 服务器类型                         |
| ------ | ---------------------------------- |
| 5s     | 开荒期、玩家会大范围跑图时         |
| 10s    | 普通服务器                         |
| 15s    | 服务器玩法决定玩家不会大范围移动时 |

## 实体

默认情况下，实体的占用一般占服务器的 40% 左右，如果不控制实体，即使是市面上最好的 CPU ，服务器也会卡顿。

### 控制实体数量

用 spark 等性能分析插件查看，应该希望将全部实体 tick 保持在 30% 以下（有一定数量的玩家在线的情况）。

在 `bukkit.yml` 和 `paper-world-default` 中都有一样的配置，但 paper 如果设置将覆盖 bukkit 的。

所以建议直接在 `paper-world-default` 中设置：

```yaml
spawn-limits:
  monsters: 70
  #怪物包括 远古守卫者、末影人、监守者、蠹虫、猪灵蛮兵、流浪者、幻术师、骷髅、潜影贝、僵尸疣猪兽、守卫者、岩浆怪、僵尸村民、僵尸猪灵、卫道士、幻翼、猪灵、史莱姆、末影龙、溺尸、掠夺者、唤魔者、僵尸、蜘蛛、尸壳、恶魂、劫掠兽、疣猪兽、洞穴蜘蛛、女巫、枯萎、末影螨、凋灵骷髅、烈焰人、巨人、爬行者、恼鬼。
  animals: 10
  #动物包括 猪、北极熊、狐狸、猫、僵尸马、嗅探者、熊猫、兔子、狼、牛、海龟、青蛙、悦灵、行商羊驼、驴、蜜蜂、骆驼、绵羊、蝌蚪、豹猫、鸡、哞菇、马、羊驼、流浪商人、鹦鹉、山羊、骡、骷髅马刷、炽足兽.
  water-animals: 5
  # 包括鱿鱼和海豚
  water-ambient: 20
  # 包括鳕鱼、河豚、鲑鱼、热带鱼
  water-underground-creature: 5
  # 包括发光鱿鱼
  axolotls: 5
  # 美西螈
  ambient: 15
  # 只包括蝙蝠，建议0
```

生物生成最大数量为 `玩家数量 * 生成限制`，该值越小，玩家能遇到的生物就越少，不同生物类型在每个玩家附近生成的概率是平均的。

这是一把双刃剑：较低的值会减轻服务器负担，但在大多数游戏模式中，自然生成的生物是游戏玩法的重要组成部分。

下表推荐了三种不同情况的推荐值，请结合服务器卡顿程度和玩法选择合适的值：

| 生物类型                   | 推荐最小值 | 推荐值 | 推荐最大值 |
| -------------------------- | ---------- | ------ | ---------- |
| monster                    | 18         | 30     | 45         |
| animal                     | 5          | 8      | 10         |
| water-animals              | 2          | 3      | 5          |
| water-ambient              | 2          | 3      | 5          |
| water-underground-creature | 3          | 4      | 5          |
| axolotls                   | 3          | 4      | 5          |
| ambient                    | 0          | 1      | 1          |

另外，在 `spigot.yml` 中有关于生物生成范围的设置：

```yaml
mob-spawn-range: 8
```

因为我们降低了总生物的刷新频率和数量，生物的总密度会明显下降，考虑到过远处的怪物对于游戏性影响非常小。

我们可以缩小生物刷新范围（以区块为单位，且不会大于[模拟距离](#手动调整)）从而获得和原版接近的密度。

推荐值：

| `spawn-limit` 值 | 对应 `mob-spawn-range`推荐值 | 实际生物量 |
| :--------------: | :--------------------------: | :----------: |
|    70 (默认)     |           8（默认)           |   100% (默认)   |
|        56        |             6-7               |     90%    |
|        42        |             5-6               |     78%     |
|        28        |             4-5               |     65%     |
|        14        |             3-4               |     48%     |

### 刷新速度

在 `bukkit.yml` 中有关于生物生成频率的设置：

```yaml
ticks-per:
  animal-spawns: 400
  monster-spawns: 1
  water-spawns: 1
  water-ambient-spawns: 1
  water-underground-creature-spawns: 1
  axolotl-spawns: 1
  ambient-spawns: 1
```

这个参数控制了多少 tick 后服务器会进行一次生物的刷新，可以看到默认情况下是每个 tick 都刷新，即每秒 20 次。

这无疑是非常繁重的工作，但调整这个值到太高会导致即使服务器生物没有到达上限，生物刷新频率还是偏低。

```yaml
推荐值:
    monster-spawns: 9
    animal-spawns: 399
    water-spawns: 199
    water-ambient-spawns: 399
    water-underground-creature-spawns: 399
    axolotl-spawns: 399
    ambient-spawns: 999
```

:::tip

为什么选择 9 、199 之类的数字作为刷新频率而不是 10、200？

因为选择 10 和 200 时，每 200 tick 就会有多种类型的生物需要刷新，任务量集中在了某一刻度上，这会导致负载不平均。

使用 9、199 时，需要每 1791 tick 才会有多种类型生物需要被刷新，刷新任务被平均在了更多 tick 中。

:::

### 生物 AI 相关

#### 生物激活范围

在 `spigot.yml` 中有一个控制生物激活范围的参数 `entity-activation-range`:

此项可以设置实体的激活AI距离（方块为单位）。降低这些值有助于提高性能，

但可能会导致怪物反应迟钝。将此值降低太多可能会破坏某些生物农场，比如刷铁机。

```yaml
推荐值:
    entity-activation-range:
      animals: 16
      monsters: 24
      raiders: 48
      misc: 8
      water: 8
      villagers: 16
      flying-monsters: 48
```

#### 村民相关

在 `spigot.yml` 中有一个参数可以降低村民非活跃情况的占用：

```yaml
tick-inactive-villagers: true
```

非活跃的定义是村民在上述参数 `entity-activation-range` 中 `villagers` 所设定的范围外时。

禁用此功能将有助于提高性能，但在某些情况下会让远处的村民更蠢，此项还会降低刷铁机等的效率。

`推荐值：false`


TODO